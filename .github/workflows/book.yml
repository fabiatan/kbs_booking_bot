name: KBS Booking Bot

on:
  schedule:
    - cron: '58 15 * * 0,2-6'  # 11:58 PM MYT on tue-Sun (books Mon-Fri 61 days ahead)
  workflow_dispatch:
    inputs:
      poll_timeout:
        description: 'Poll timeout in seconds'
        required: false
        default: '900'
        type: string
      date:
        description: 'Specific date to book (DD/MM/YYYY), leave empty for auto'
        required: false
        default: ''
        type: string
      days_ahead:
        description: 'Number of days ahead to book (default: 61 = 8 weeks + 5 days)'
        required: false
        default: '61'
        type: string

jobs:
  book:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install requests
      
      - name: Run booking bot (Daily)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python kbs_booker_bot.py \
            -u "${{ secrets.KBS_USERNAME }}" \
            -p "${{ secrets.KBS_PASSWORD }}" \
            ${{ inputs.days_ahead && format('--days-ahead {0}', inputs.days_ahead) || '' }} \
            ${{ inputs.date != '' && format('-d "{0}"', inputs.date) || '' }} \
            ${{ inputs.poll_timeout && format('--poll-timeout {0}', inputs.poll_timeout) || '' }}
